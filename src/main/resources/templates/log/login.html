<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç™»å½•æ—¥å¿—é£é™©æ—¶é—´è½´</title>
    <link rel="stylesheet" href="/layui/css/layui.css">
    <style>
        body {
            background-color: #f7f7f7;
            font-family: "Microsoft YaHei", sans-serif;
        }

        .layui-container {
            margin-top: 20px;
            padding-bottom: 50px;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #ffffff;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .layui-card {
            margin: 16px 0;
            border-radius: 12px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
        }

        .layui-card-header {
            background-color: #fafafa;
            font-size: 16px;
            font-weight: bold;
            padding: 14px 20px;
            border-bottom: 1px solid #eee;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .layui-card-body {
            background-color: white;
            padding: 20px;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .risk-user {
            display: inline-block;
            background: #fef0ef;
            color: #e74c3c;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 6px;
            margin-top: 5px;
        }

        .risk-time {
            display: inline-block;
            background: #fff8e6;
            color: #f39c12;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 6px;
            margin-top: 5px;
        }

        .no-data {
            padding: 30px;
            text-align: center;
            color: #999;
        }

        .search-bar-sticky {
            position: sticky;
            top: 60px;
            z-index: 99;
            background: #fff;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body>

<!-- æ ‡é¢˜ + æœç´¢æ  -->
<div class="layui-card sticky-header">
    <div class="layui-card-header">
        ğŸ•’ ç™»å½•æ—¥å¿—åˆ†æï¼ˆå«é£é™©æ ‡è®°ï¼‰
        <button class="layui-btn layui-btn-sm layui-btn-radius layui-btn-normal" style="margin-left: 12px;" id="sync-btn">
            ğŸ”„ åŒæ­¥
        </button>
    </div>
    <div class="layui-card-body">
        <div class="layui-form">
            <div class="layui-inline" style="margin-right: 10px;">
                <input type="text" id="mac-search" placeholder="ğŸ” è¾“å…¥ MAC åœ°å€ç­›é€‰" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-normal" id="search-btn">
                    <i class="layui-icon layui-icon-search"></i> æœç´¢
                </button>
                <button class="layui-btn layui-btn-primary" id="reset-btn">é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

<!-- æ—¶é—´è½´å±•ç¤º -->
<div class="layui-container" id="timeline-container"></div>

<!-- AI æŠ¥å‘Šå¼¹çª—æ¨¡æ¿ -->
<script type="text/html" id="aiReportTemplate">
    <div style="padding: 20px;">
        <h3>ğŸ§  AI åˆ†ææŠ¥å‘Š - MAC: {{d.mac}}</h3>
        <p><strong>ç™»å½•æ¬¡æ•°ï¼š</strong> {{d.total}}</p>
        <p><strong>é£é™©ç”¨æˆ·ç™»å½•ï¼š</strong> {{d.riskUser}} æ¬¡</p>
        <p><strong>éæ­£å¸¸æ—¶é—´ç™»å½•ï¼š</strong> {{d.riskTime}} æ¬¡</p>
        <p style="margin-top:10px;"><strong>æ€»ç»“ï¼š</strong> {{d.summary}}</p>
    </div>
</script>

<script src="/layui/layui.js"></script>
<script>
    layui.use(['layer', 'laytpl'], function () {
        const $ = layui.$;
        const layer = layui.layer;
        const laytpl = layui.laytpl;

        const timelineData = [
            { mac: "00:11:22:33:44:55", username: "admin", login_time: "2025-06-17 03:12:00", is_risk_user: true, is_risk_time: true },
            { mac: "00:11:22:33:44:55", username: "admin", login_time: "2025-06-17 10:12:00", is_risk_user: true, is_risk_time: false },
            { mac: "AA:BB:CC:DD:EE:FF", username: "guest", login_time: "2025-06-17 10:12:00", is_risk_user: false, is_risk_time: false },
            { mac: "66:77:88:99:AA:BB", username: "test", login_time: "2025-06-17 02:30:00", is_risk_user: false, is_risk_time: true }
        ];

        function renderTimeline(data) {
            let html = '';
            const grouped = {};

            // åˆ†ç»„ï¼šæŒ‰ mac åˆ†ç±»
            data.forEach(item => {
                if (!grouped[item.mac]) grouped[item.mac] = [];
                grouped[item.mac].push(item);
            });

            for (let mac in grouped) {
                html += `
            <div class="layui-card">
              <div class="layui-card-header">
                ğŸ’» MAC åœ°å€ï¼š<strong>${mac}</strong>
                <button class="layui-btn layui-btn-xs layui-btn-warm" style="float: right;" onclick="showAiReport('${mac}')">
                  ğŸ“Š æŸ¥çœ‹AIåˆ†ææŠ¥å‘Š
                </button>
              </div>
              <div class="layui-card-body">
                <ul class="layui-timeline">
            `;

                grouped[mac].forEach(item => {
                    html += `
                <li class="layui-timeline-item">
                  <i class="layui-icon layui-timeline-axis">î˜¿</i>
                  <div class="layui-timeline-content layui-text">
                    <h3 class="layui-timeline-title">${item.login_time}</h3>
                    <p>
                      ğŸ‘¤ ç”¨æˆ·ï¼š<strong>${item.username}</strong><br>
                      ${item.is_risk_user ? '<span class="risk-user">âš  é£é™©ç”¨æˆ·</span><br>' : ''}
                      ${item.is_risk_time ? '<span class="risk-time">â° éæ­£å¸¸æ—¶é—´ç™»å½•</span>' : ''}
                      ${(!item.is_risk_user && !item.is_risk_time) ? 'âœ… æ­£å¸¸ç™»å½•' : ''}
                    </p>
                  </div>
                </li>
                `;
                });

                html += `</ul></div></div>`;
            }

            $('#timeline-container').html(html || '<div class="no-data">âš  æ²¡æœ‰åŒ¹é…çš„è®°å½•</div>');
        }

        // ç‚¹å‡»æŒ‰é’®å±•ç¤ºAIåˆ†æ
        window.showAiReport = function(mac) {
            const records = timelineData.filter(item => item.mac === mac);
            const total = records.length;
            const riskUser = records.filter(r => r.is_risk_user).length;
            const riskTime = records.filter(r => r.is_risk_time).length;

            let summary = 'è¯¥è®¾å¤‡ç™»å½•è®°å½•æ­£å¸¸ã€‚';
            if (riskUser || riskTime) {
                summary = 'è¯¥è®¾å¤‡å­˜åœ¨éƒ¨åˆ†å¼‚å¸¸è¡Œä¸ºï¼š';
                if (riskUser) summary += `åŒ…å« ${riskUser} æ¬¡é£é™©ç”¨æˆ·ç™»å½•ï¼›`;
                if (riskTime) summary += `åŒ…å« ${riskTime} æ¬¡éæ­£å¸¸æ—¶é—´ç™»å½•ï¼›`;
            }

            layer.open({
                type: 1,
                title: false,
                area: ['400px', '300px'],
                shadeClose: true,
                content: laytpl($('#aiReportTemplate').html()).render({
                    mac: mac,
                    total: total,
                    riskUser: riskUser,
                    riskTime: riskTime,
                    summary: summary
                })
            });
        };

        // æœç´¢æŒ‰é’®
        $('#search-btn').on('click', function () {
            const keyword = $('#mac-search').val().trim().toLowerCase();
            const filtered = timelineData.filter(item => item.mac.toLowerCase().includes(keyword));
            renderTimeline(filtered);
        });

        // é‡ç½®æŒ‰é’®
        $('#reset-btn').on('click', function () {
            $('#mac-search').val('');
            renderTimeline(timelineData);
        });

        // åˆå§‹åŒ–
        renderTimeline(timelineData);
    });
</script>
</body>
</html>
