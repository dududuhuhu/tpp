<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®¡è®¡æ—¥å¿—æ—¶é—´è½´</title>
    <link rel="stylesheet" href="/layui/css/layui.css">
    <link rel="stylesheet" href="/layui/layuiAdmin/css/admin.css">
    <style>
        body {
            background-color: #f7f7f7;
            font-family: "Microsoft YaHei", sans-serif;
        }
        .layui-container { margin-top: 20px; padding-bottom: 50px; }
        .sticky-header {
            position: sticky; top: 0; z-index: 100; background-color: #fff;
            padding: 16px 20px; font-size: 18px; font-weight: bold;
            color: #333; border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }
        .layui-card { margin: 16px 0; border-radius: 12px; box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06); }
        .layui-card-header {
            background-color: #fafafa; font-size: 16px; font-weight: bold;
            padding: 14px 20px; border-bottom: 1px solid #eee;
            border-top-left-radius: 12px; border-top-right-radius: 12px;
        }
        .layui-card-body {
            background-color: white; padding: 20px;
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
        }
        .no-data {
            padding: 30px; text-align: center; color: #999;
        }
        .search-bar-sticky {
            position: sticky; top: 60px; z-index: 99; background: #fff;
            padding: 12px 20px; border-bottom: 1px solid #eee;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
        }
    </style>
</head>
<body>

<!-- æ ‡é¢˜ + æœç´¢æ  -->
<div class="layui-card sticky-header">
    <div class="layui-card-header">
        ğŸ•’ ç™»å½•æ—¥å¿—åˆ†æï¼ˆå«é£é™©æ ‡è®°ï¼‰
        <button class="layui-btn layui-btn-sm layui-btn-radius layui-btn-normal" style="margin-left: 12px;" id="sync-btn">
            ğŸ”„ åŒæ­¥
        </button>
    </div>
    <div class="layui-card-body">
        <div class="layui-form">
            <div class="layui-inline" style="margin-right: 10px;">
                <input type="text" id="mac-search" placeholder="ğŸ” è¾“å…¥ MAC åœ°å€ç­›é€‰" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline" style="margin-right: 10px;">
                <input type="text" id="start-time" placeholder="å¼€å§‹æ—¶é—´" class="layui-input">
            </div>
            <div class="layui-inline" style="margin-right: 10px;">
                <input type="text" id="end-time" placeholder="ç»“æŸæ—¶é—´" class="layui-input">
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-normal" id="search-btn"><i class="layui-icon layui-icon-search"></i> æœç´¢</button>
                <button class="layui-btn layui-btn-primary" id="reset-btn">é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

<!-- æ—¶é—´è½´å±•ç¤º -->
<div class="layui-container" id="timeline-container"></div>
<div id="pagination" style="text-align: center; padding: 20px;"></div>

<script src="/layui/layui.js"></script>
<script>
    layui.config({ base: '/layui/layuiAdmin/' }).extend({ index: 'lib/index' }).use(['layer', 'form', 'laydate', 'laypage'], function () {
        var $ = layui.$,
            form = layui.form,
            layer = layui.layer,
            laydate = layui.laydate,
            laypage = layui.laypage;

        laydate.render({ elem: '#start-time', type: 'datetime' });
        laydate.render({ elem: '#end-time', type: 'datetime' });

        function getRiskColor(event_id) {
            if ([4720, 4726, 4738].includes(event_id)) return '#e74c3c';
            if ([4670, 4723].includes(event_id)) return '#f39c12';
            return '#5FB878';
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ– ISO æ—¶é—´ä¸º yyyy-MM-dd HH:mm:ssï¼ˆè‡ªåŠ¨è½¬ä¸œå…«åŒºï¼‰
        function formatDateTime(isoString) {
            if (!isoString) return 'æœªçŸ¥';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¶é—´';
            return new Date(date.getTime() + 8 * 60 * 60 * 1000) // è½¬ä¸œå…«åŒº
                .toISOString().replace('T', ' ').substring(0, 19);
        }


        function renderTimelines(data) {
            if (data.length === 0) {
                document.getElementById('timeline-container').innerHTML = '<p class="no-data">æš‚æ— åŒ¹é…çš„å®¡è®¡æ—¥å¿—</p>';
                return;
            }
            let html = '';
            data.forEach(user => {
                let userHTML = `<div class="layui-card">
                    <div class="layui-card-header" style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; line-height: 1.8; gap: 8px;">
                        <div style="font-weight: bold;">ğŸ‘¤ ${user.username}</div>
                        <div style="flex: 1 1 auto;">
    ğŸ’» MAC: ${user.mac}ã€€
    ğŸŸ¢ ç™»å½•ï¼š<span style="color:green">${formatDateTime(user.loginTime)}</span>ã€€
    ğŸ”´ æ³¨é”€ï¼š<span style="color:red">${formatDateTime(user.logoffTime)}</span>
</div>

                       <div style="flex-shrink: 0;">
  <button class="layui-btn layui-btn-xs layui-btn-danger ai-btn"
          data-mac="${user.mac}"
          data-username="${user.username}"
          data-loginTime="${user.loginTime}">
      ğŸ§  æŸ¥çœ‹AIåˆ†æ
  </button>
</div>
                    </div>
                    <div class="layui-card-body">
                        <ul class="layui-timeline">`;
                user.actions.forEach(action => {
                    console.log("action:",action);
                    userHTML += `<li class="layui-timeline-item">
                            <i class="layui-icon layui-timeline-axis" style="color: ${getRiskColor(action.event_id)}">î˜¿</i>
                            <div class="layui-timeline-content layui-text">
                                <h3 class="layui-timeline-title">${action.timestamp}</h3>
                                <p><strong>${action.action}</strong>ï¼ˆäº‹ä»¶ID: ${action.eventId}ï¼‰<br>${action.details || 'æš‚æ— è¯¦æƒ…'}</p>
                            </div>
                        </li>`;
                });
                userHTML += `</ul></div></div>`;
                html += userHTML;
            });
            $('#timeline-container').html(html);
        }

        let page = 1;
        let limit = 5;
        let totalCount = 0;
        let latestCreateTime = null;

        function getMaxCreateTime(data) {
            if (!Array.isArray(data)) return null;
            const times = data
                .map(item => {
                    const ts = item.logoffTime || item.loginTime;
                    const d = new Date(ts);
                    return isNaN(d.getTime()) ? null : d;
                })
                .filter(d => d !== null);
            return times.length ? new Date(Math.max(...times)).toISOString() : null;
        }

        function fetchData() {
            const mac = $('#mac-search').val().trim();
            const start = $('#start-time').val();
            const end = $('#end-time').val();

            $.ajax({
                url: '/logs/audit',
                type: 'POST',
                headers: {
                    'Authorization': localStorage.getItem('token'),
                    'userId':localStorage.getItem('id')
                },
                contentType: 'application/json',
                data: JSON.stringify({ mac: mac || null, loginTime: start || null, logoffTime: end || null, page: page, limit: limit }),
                success: function (res) {
                    console.log("res:",res);
                    if (res.code === 0) {
                        totalCount = res.count || 0;
                        const newMaxTime = getMaxCreateTime(res.data || []);
                        if (newMaxTime !== latestCreateTime) {
                            latestCreateTime = newMaxTime;
                            renderTimelines(res.data || []);
                            renderPagination();
                        }
                    } else {
                        $('#timeline-container').html('<div class="no-data">åŠ è½½å¤±è´¥</div>');
                    }
                },
                error: function () {
                    $('#timeline-container').html('<div class="no-data">æ¥å£å¼‚å¸¸</div>');
                }
            });
        }

        setInterval(() => { fetchData(); }, 10000);

        function renderPagination() {
            laypage.render({
                elem: 'pagination',
                count: totalCount,
                limit: limit,
                curr: page,
                layout: ['prev', 'page', 'next', 'count'],
                jump: function (obj, first) {
                    if (!first) {
                        page = obj.curr;
                        limit = obj.limit;
                        fetchData();
                    }
                }
            });
        }

        $(document).on('click', '.ai-btn', function () {
            const mac = $(this).data('mac');
            const username=$(this).data('username');
            const loginTime=$(this).data('loginTime');
            layer.load(1, {shade: [0.1, '#fff']});

            $.ajax({
                url: '/api/report/audit/analyze',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': localStorage.getItem('token'),
                    'userId': localStorage.getItem('id')
                },
                data: JSON.stringify({mac: mac,username:username,loginTime:loginTime}),
                success: function (res) {
                    console.log("reportres:",res);
                    layer.closeAll('loading');
                    if (res && res.overall_risk_level) {
                        const data = res;

                        // æ„é€  HTMLï¼ˆæ•´åˆå›¾è¡¨å®¹å™¨å’Œæ–‡å­—æŠ¥å‘Šï¼‰
                        let html = `
                    <div style="padding: 20px; font-size: 14px;">
                        <h2 style="margin-bottom: 10px;">ğŸ“Š é£é™©åˆ†ææŠ¥å‘Š</h2>
                       <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                            <!-- æ•´ä½“é£é™©ç­‰çº§å¡ç‰‡ -->
                            <div style="flex: 1; background: #fff5f5; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 26px; color: #e74c3c;">${data.overall_risk_level}</div>
                                    <div style="color: #e74c3c; font-weight: bold;">ğŸ”´ æ•´ä½“é£é™©ç­‰çº§</div>
                                </div>
                                <div style="font-size: 28px;">ğŸ“Š</div>
                            </div>

                            <!-- é«˜é£é™©äº‹ä»¶æ•°å¡ç‰‡ -->
                            <div style="flex: 1; background: #fffaf0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 26px; color: #f39c12;">${data.high_risk_event_count}</div>
                                    <div style="color: #f39c12; font-weight: bold;">ğŸ“Œ é«˜é£é™©äº‹ä»¶æ•°</div>
                                </div>
                                <div style="font-size: 28px;">ğŸ“</div>
                            </div>
                        </div>

                        <div id="risk-chart" style="width: 100%; height: 250px; margin-top: 20px;"></div>
                        <div id="freq-chart" style="width: 100%; height: 250px; margin-top: 20px;"></div>

                        <h3 style="margin-top: 30px;">ğŸ“Œ é«˜é£é™©äº‹ä»¶</h3>
                        ${data.high_risk_events.map(e => `
                            <div style="background: #f9f9f9; padding: 10px 15px; margin: 10px 0; border-left: 5px solid #e74c3c; border-radius: 6px;">
                                <p><strong>äº‹ä»¶IDï¼š</strong>${e.event_id} | <strong>è¯„åˆ†ï¼š</strong>${e.risk_score}</p>
                                <p><strong>æ“ä½œï¼š</strong>${e.action}</p>
                                <p><strong>æè¿°ï¼š</strong>${e.risk_description}</p>
                                <p><strong>æ—¶é—´ï¼š</strong>${e.event_time}</p>
                                <p><strong>ç›®æ ‡ç”¨æˆ·ï¼š</strong>${e.target_user} | <strong>æ“ä½œè€…ï¼š</strong>${e.operator_user}</p>
                            </div>
                        `).join('')}



                        <h3 style="margin-top: 30px;">ğŸ“ é£é™©æè¿°</h3>
                        <p>${data.risk_description}</p>

                        <h3 style="margin-top: 30px;">âœ… å»ºè®®æªæ–½</h3>
                        <p>${data.suggested_action}</p>
                    </div>
                `;

                        // æ‰“å¼€å¼¹çª— + å›¾è¡¨æ¸²æŸ“
                        layer.open({
                            type: 1,
                            title: 'AI é£é™©åˆ†ææŠ¥å‘Š',
                            area: ['100%', '100%'],     // æœ€å¤§åŒ–å°ºå¯¸
                            offset: '0px',
                            shadeClose: true,
                            content: `<div style="max-height: 580px; overflow-y: auto;">${html}</div>`,
                            success: function () {
                                const riskChart = echarts.init(document.getElementById('risk-chart'));
                                riskChart.setOption({
                                    title: {text: 'é£é™©è¯„åˆ†åˆ†å¸ƒ', left: 'center'},
                                    tooltip: {},
                                    xAxis: {
                                        type: 'category',
                                        data: data.risk_scores.map(r => r.event_id),
                                        name: 'äº‹ä»¶ID'
                                    },
                                    yAxis: {
                                        type: 'value',
                                        name: 'è¯„åˆ†',
                                        max: 10
                                    },
                                    series: [{
                                        data: data.risk_scores.map(r => r.risk_score),
                                        type: 'bar',
                                        itemStyle: {color: '#e74c3c'}
                                    }]
                                });

                                const freqChart = echarts.init(document.getElementById('freq-chart'));
                                freqChart.setOption({
                                    title: {text: 'ç”¨æˆ·æ“ä½œé¢‘ç‡', left: 'center'},
                                    tooltip: {trigger: 'item'},
                                    legend: {bottom: '0%'},
                                    series: [{
                                        type: 'pie',
                                        radius: '55%',
                                        data: data.operation_frequencies.map(f => ({
                                            name: f.user,
                                            value: f.frequency
                                        })),
                                        label: {
                                            formatter: '{b}: {c}æ¬¡ ({d}%)'
                                        }
                                    }]
                                });
                            }
                        });
                    } else {
                        layer.msg('AIåˆ†æå¤±è´¥ï¼šæ•°æ®å¼‚å¸¸', {icon: 2});
                    }
                },
                error: function () {
                    layer.closeAll('loading');
                    layer.msg('AIåˆ†æè¯·æ±‚å¤±è´¥', {icon: 2});
                }
            });
        });

        // åŒæ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#sync-btn').click(function () {
            layer.load(1, { shade: [0.1, '#fff'] }); // åŠ è½½åŠ¨ç”»

            $.ajax({
                url: '/logs/audit/sync',  // åç«¯è§¦å‘æ¶ˆæ¯é˜Ÿåˆ—çš„æ¥å£
                type: 'POST',
                headers: {
                    'Authorization': localStorage.getItem('token'),
                    'userId':localStorage.getItem('id')
                },
                success: function (res) {
                    layer.closeAll('loading');
                    if (res.code === 0) {
                        layer.msg('åŒæ­¥è¯·æ±‚å·²å‘é€ï¼Œç¨åè‡ªåŠ¨åˆ·æ–°æ•°æ®');
                    } else {
                        layer.msg('åŒæ­¥å¤±è´¥ï¼š' + res.msg, { icon: 2 });
                    }
                },
                error: function () {
                    layer.closeAll('loading');
                    layer.msg('åŒæ­¥è¯·æ±‚å¤±è´¥', { icon: 2 });
                }
            });
        });

        $('#search-btn').click(function () { page = 1; fetchData(); });
        $('#reset-btn').click(function () { $('#mac-search').val(''); $('#start-time').val(''); $('#end-time').val(''); page = 1; fetchData(); });
        fetchData();
    });
</script>
</body>
</html>
