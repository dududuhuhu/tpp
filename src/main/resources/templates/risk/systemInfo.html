<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>系统风险详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <style>
        .st {
            width: 270px!important;
        }
        .layui-form-label {
            width: 120px!important;
        }
        .xinghao {
            color: red!important;
        }

        #assetInfoContent {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 150px;
        }
        #assetInfoContent .layui-row {
            min-height: 50px;
            box-sizing: border-box;
        }
        #assetInfoContent .layui-col-xs4 {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        #assetInfoContent .layui-col-xs4 > label {
            white-space: nowrap;
            font-weight: bold;
            margin-right: 6px;
            margin-left: 6px;
            flex-shrink: 0;
        }

        #assetInfoContent .layui-col-xs4 > span {
            flex: 1;
            color: #666;
            word-break: break-word;
        }

        .layui-tab {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-top: 20px;
        }

        /* 标签内容区域 */
        .layui-tab-content {
            padding: 20px 15px;
            background-color: #fafafa;
            border-radius: 0 8px 8px 8px;
            min-height: 150px;
            color: #444;
            font-size: 14px;
            line-height: 1.6;
            user-select: text;
        }

        /* 加载中的文本美化 */
        .layui-tab-content p {
            color: #999;
            font-style: italic;
            text-align: center;
            margin: 40px 0;
        }

        .layui-tab-brief .layui-tab-title {
            display: flex;
            gap: 24px;
            padding-left: 10px;
        }

        .layui-tab-brief .layui-tab-title li {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .layui-tab-brief .layui-tab-title li.layui-this {
            color: #009688;
            border-bottom-color: #009688;
            font-weight: 700;
            background: none !important;
            box-shadow: none !important;
        }

        /* 图表容器样式 */
        #riskLevelChart, #riskTypeChart {
            width: 100%;
            height: 300px;
        }

    </style>
</head>
<body>

<div class="layui-container" style="width: 100%;">
    <div class="layui-row">
        <div class="layui-col-md12">

            <!-- 主机信息卡片 -->
            <div class="layui-card">
                <div class="layui-card-header">
                    <span>主机信息</span>
                </div>
                <div class="layui-card-body">
                    <div id="assetInfoContent" style="margin-bottom: 20px">
                        <div class="layui-row">
                            <div class="layui-col-xs4">
                                <label>主机名：</label><span id="hostName">这是一个很长很长很长很长的主机名示例，测试换行对齐效果</span>
                            </div>
                            <div class="layui-col-xs4">
                                <label>MAC地址：</label><span id="macAddress">00-11-22-33-44-55</span>
                            </div>
                            <div class="layui-col-xs4">
                                <label>IP地址：</label><span id="ipAddress">192.168.1.100</span>
                            </div>
                        </div>
                        <div class="layui-row">
                            <div class="layui-col-xs4">
                                <label>系统类型：</label><span id="osType">Windows 10 专业版，64位，长期支持版本</span>
                            </div>
                            <div class="layui-col-xs4">
                                <label>系统名字：</label><span id="osName">Windows 10 Pro</span>
                            </div>
                            <div class="layui-col-xs4">
                                <label>位数：</label><span id="osBit">64位</span>
                            </div>
                        </div>
                        <div class="layui-row">
                            <div class="layui-col-xs4">
                                <label>CPU：</label><span id="cpuName">Intel Core i7-10700K @ 3.8GHz</span>
                            </div>
                            <div class="layui-col-xs4">
                                <label>内存：</label><span id="ram">16 GB DDR4</span>
                            </div>
                            <div class="layui-col-xs4">
                                <label>状态：</label><span id="status">运行中</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 风险统计图表 -->
            <div class="layui-card" style="margin-top: 20px;">
                <div class="layui-card-header">风险统计</div>
                <div class="layui-card-body">
                    <div id="riskLevelChart"></div>
                    <div id="riskTypeChart" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="layui-card">
                <div class="layui-card-header">
                    系统风险探测详情
                </div>
                <div class="layui-card-body">
                    <table id="patchTable" lay-filter="patchTableFilter"></table>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="/layui/layui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

<script type="text/javascript">
    // 日期格式转换函数
    function formatDate(str) {
        if (str != null) {
            var now = new Date(str);
            var year = now.getFullYear();
            var month = now.getMonth() + 1;
            var date = now.getDate();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var seconds = now.getSeconds();

            // 补零处理
            month = month < 10 ? "0" + month : month;
            date = date < 10 ? "0" + date : date;
            hours = hours < 10 ? "0" + hours : hours;
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            return year + "-" + month + "-" + date + " " + hours + ":" + minutes + ":" + seconds;
        }
        return "";
    }

    function renderRiskCharts(levelCount, typeCount) {
        const levelChart = echarts.init(document.getElementById('riskLevelChart'));
        levelChart.setOption({
            title: { text: '风险等级分布' },
            tooltip: {},
            xAxis: { type: 'category', data: Object.keys(levelCount) },
            yAxis: { type: 'value' },
            series: [{
                data: Object.values(levelCount),
                type: 'bar',
                itemStyle: { color: '#009688' }
            }]
        });

        const typeChart = echarts.init(document.getElementById('riskTypeChart'));
        typeChart.setOption({
            title: { text: '风险类型分布' },
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                data: Object.keys(typeCount)
            },
            series: [{
                type: 'pie',
                radius: '50%',
                data: Object.keys(typeCount).map(k => ({ name: k, value: typeCount[k] })),
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        });

        // 自适应图表大小
        window.addEventListener('resize', () => {
            levelChart.resize();
            typeChart.resize();
        });
    }
</script>

<script type="text/javascript" th:inline="none">
    layui.config({
        base: '/layui/layuiAdmin/'
    }).extend({
        index: 'lib/index'
    }).use(['element', 'jquery', 'table'], function () {
        var $ = layui.$,
            element = layui.element,
            table = layui.table;

        window.addEventListener('message', function (event) {
            var data = event.data;
            console.log('收到资产数据：', data);

            if (data && typeof data === 'object') {
                document.getElementById('hostName').textContent = data.hostName || '';
                document.getElementById('macAddress').textContent = data.macAddress || '';
                document.getElementById('ipAddress').textContent = data.ipAddress || '';
                document.getElementById('osType').textContent = data.osType || '';
                document.getElementById('osName').textContent = data.osName || '';
                document.getElementById('osBit').textContent = data.osBit || '';
                document.getElementById('cpuName').textContent = data.cpuName || '';
                document.getElementById('ram').textContent = data.ram || '';

                var statusHtml = '';
                if (data.status === 1 || data.status === '1') {
                    statusHtml = '<button class="layui-btn layui-btn-normal layui-btn-xs">在线</button>';
                } else if (data.status === 0 || data.status === '0') {
                    statusHtml = '<button class="layui-btn layui-btn-danger layui-btn-xs">离线</button>';
                } else if (data.status) {
                    statusHtml = '<button class="layui-btn layui-btn-warm layui-btn-xs">' + data.status + '</button>';
                } else {
                    statusHtml = '';
                }
                document.getElementById('status').innerHTML = statusHtml;

                // 渲染风险详情表格
                table.render({
                    elem: '#patchTable',
                    url: '/host/systemRisk',
                    method: 'post',
                    contentType: 'application/json',
                    headers: {
                        'Authorization': localStorage.getItem('token')?.replace(/^Bearer\s/, '')
                    },
                    where: JSON.stringify({
                        macAddress: data.macAddress,
                        page: 1,
                        limit: 5
                    }),
                    parseData: function(res){
                        return {
                            code: res.code,
                            msg: res.msg,
                            count: res.count,
                            data: res.data
                        };
                    },
                    cols: [[
                        {type: 'checkbox', fixed: 'left'},
                        {field: 'ruleId', title: '规则ID', width: 75},
                        {field: 'riskName', title: '风险名称', minWidth: 220},
                        {
                            field: 'riskLevel',
                            title: '风险等级',
                            width: 86,
                            align: 'center',
                            templet: function (d) {
                                const levelMap = {
                                    1: {text: '低', color: '#5FB878'},
                                    2: {text: '中', color: '#FFB800'},
                                    3: {text: '高', color: '#FF5722'},
                                    4: {text: '严重', color: '#FF0000'}
                                };
                                const level = levelMap[d.riskLevel] || {text: '未知', color: '#909399'};
                                return `<span class="layui-btn layui-btn-xs" style="background-color:${level.color};">${level.text}</span>`;
                            }
                        },
                        {
                            field: 'isRisky',
                            title: '是否风险',
                            width: 87,
                            align: 'center',
                            templet: function (d) {
                                return d.isRisky ? '<button class="layui-btn layui-btn-danger layui-btn-xs">是</button>' : '<button class="layui-btn layui-btn-normal layui-btn-xs">否</button>';
                            }
                        },
                        {field: 'detectionOutput', title: '检测输出', width: 75},
                        {field: 'riskDetail', title: '检测细节', width: 75},
                        {field: 'remediationAdvice', title: '修复建议', minWidth: 200},
                        {field:'createTime', title:'采集时间', width: 160, templet: d => formatDate(d.createTime)},
                        {field:'updateTime', title:'上线时间', width: 160, templet: d => d.updateTime ? formatDate(d.updateTime) : formatDate(d.createTime)}
                        ,{field:'createdAt', title:'采集时间',width: 160, templet: d => formatDate(d.createdAt)}
                        ,{field:'updatedAt', title:'上线时间',width: 160, templet: d => d.updateTime ? formatDate(d.updateTime) : formatDate(d.updatedAt)}
                    ]],
                    page: {curr: 1, limit: 5},
                    limits: [5, 10, 15, 20],
                    done: function(res, curr, count) {
                        // 统计风险等级、类型
                        const levelCount = {};
                        const typeCount = {};

                        res.data.forEach(item => {
                            const level = item.riskLevel || '未知';
                            levelCount[level] = (levelCount[level] || 0) + 1;

                            // 注意：这里字段名可能是riskType，需根据接口实际字段调整
                            const type = item.riskType || '未知';
                            typeCount[type] = (typeCount[type] || 0) + 1;
                        });

                        renderRiskCharts(levelCount, typeCount);
                    }
                });
            }
        });
    });
</script>

</body>
</html>
